version: 2.1

orbs:
  docker: circleci/docker@2.4.0
  aws-cli: circleci/aws-cli@4.0

# Define the jobs we want to run for this project
jobs:
  # testing:
    # docker:
      # - image: cimg/python:3.8
        # environment:
          # SECRET_KEY: $SECRET_KEY
          # SENTRY_DSN: $SENTRY_DSN
          # DEBUG: $DEBUG
    # steps:
      # - checkout
      # - run:
          # name: install dependencies
          # command: |
            # python3 -m venv env
            # source env/bin/activate
            # pip install -r requirements.txt
      # - run:
          # name: launch test
          # command: |
            # source env/bin/activate
            # flake8
            # pytest --cov
            # echo "TESTING COMMIT $CIRCLE_SHA1"
# 
  # publish_docker:
  #   docker:
  #     - image: cimg/python:3.9
  #       environment:
  #         SECRET_KEY: $SECRET_KEY
  #         SENTRY_DSN: $SENTRY_DSN
  #         DEBUG: $DEBUG
  #   steps:
  #     - checkout
  #     - setup_remote_docker:
  #         version: 20.10.12
  #     - run:
  #         name: Build and publish Docker image
  #         command: |
  #           docker login -u $DOCKER_LOGIN -p $DOCKER_PASSWORD
  #           docker build -t $DOCKER_LOGIN/oc-lettings:$CIRCLE_SHA1 \
  #           --build-arg SECRET_KEY=$SECRET_KEY \
  #           --build-arg SENTRY_DSN=$SENTRY_DSN \
  #           --build-arg DEBUG=$DEBUG \
  #           .
  #           docker push $DOCKER_LOGIN/oc-lettings:$CIRCLE_SHA1
  deploy_to_aws:
    docker:
      - image: cimg/python:3.8
        environment:
          AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
    steps:
      - checkout
      - run:
          name: Deploye
          command: |
            echo "$SSH_KEY" >> /tmp/deploy_key
            chmod 600 /tmp/deploy_key
            echo $SSH_HOST
            ssh -i /tmp/deploy_key circleci@$SSH_HOST date


workflows:
  build_and_test:
    jobs:
      # # - testing
      # - publish_docker
      #     # requires:
      #       # - testing
      - deploy_to_aws